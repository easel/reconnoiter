.SUFFIXES: .lo .@MODULEEXT@ .xml .xmlh

CC=@CC@
LD=@LD@
CPPFLAGS=@CPPFLAGS@
CFLAGS=@CFLAGS@
PGCFLAGS=@PGCFLAGS@
MYCFLAGS=@MYCFLAGS@
SHCFLAGS=@SHCFLAGS@
MODULELD=@MODULELD@
MODULEEXT=@MODULEEXT@
LDFLAGS=@LDFLAGS@
AR=@AR@
RANLIB=@RANLIB@
LIBS=@LIBS@
PGLIBS=@PGLIBS@
MYLIBS=@MYLIBS@
INSTALL=@INSTALL@
MODULES_DIR=@MODULES_DIR@
XSLTPROC=@XSLTPROC@
XMLLINT=@XMLLINT@
XML2H=@top_srcdir@/buildtools/xml2h

top_srcdir=@top_srcdir@

MODULES=ping_icmp.@MODULEEXT@ postgres.@MODULEEXT@ \
	lua.@MODULEEXT@ dns.@MODULEEXT@ selfcheck.@MODULEEXT@ \
	external.@MODULEEXT@ collectd.@MODULEEXT@ \
	@BUILD_MODULES@

all:	$(MODULES)

.xml.xmlh:
	@$(XML2H) `echo $< | sed -e 's/\.xml$$//;'`_xml_description < $< > $@

selfcheck.lo:	selfcheck.xmlh

lua.@MODULEEXT@:	lua.lo lua_noit.lo
	@$(MODULELD) $(LDFLAGS) -o $@ lua.lo lua_noit.lo ../lua/liblua.lo
	@echo "- linking $@"

lua.lo:	lua.c lua.xmlh
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) -I$(top_srcdir)/src/lua/src -c lua.c -o $@
	@echo "- compiling $<"

lua_noit.lo:	lua_noit.c
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) -I$(top_srcdir)/src/lua/src -c lua_noit.c -o $@
	@echo "- compiling $<"

postgres.@MODULEEXT@:	postgres.lo
	@$(MODULELD) $(LDFLAGS) -o $@ postgres.lo $(PGLIBS) -lz -lssl -lcrypto
	@echo "- linking $@"

postgres.lo:	postgres.c postgres.xmlh
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) $(PGCFLAGS) -c $< -o $@
	@echo "- compiling $<"

mysql.@MODULEEXT@:	mysql.lo
	@$(MODULELD) $(LDFLAGS) -o $@ mysql.lo $(MYLIBS)
	@echo "- linking $@"

mysql.lo:	mysql.c mysql.xmlh
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) $(MYCFLAGS) -c $< -o $@
	@echo "- compiling $<"

dns.@MODULEEXT@:	dns.lo
	@$(MODULELD) $(LDFLAGS) -o $@ dns.lo
	@echo "- linking $@"

dns.lo:	dns.c dns.xmlh
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) -c $< -o $@
	@echo "- compiling $<"

snmp.@MODULEEXT@:	snmp.lo
	@$(MODULELD) $(LDFLAGS) -o $@ snmp.lo -lnetsnmp
	@echo "- linking $@"

ssh2.@MODULEEXT@:	ssh2.lo
	@$(MODULELD) $(LDFLAGS) -o $@ ssh2.lo -lssh2
	@echo "- linking $@"

collectd.@MODULEEXT@: collectd.lo
	@$(MODULELD) $(LDFLAGS) -o $@ collectd.lo -lssl 
	@echo "- linking $@"

collectd.lo: collectd.c collectd.xmlh
	@$(CC) $(CPPFLAGS) $(CFLAGS) $(SHCFLAGS) -c collectd.c -o $@
	@echo "- compiling $<"

ssh2.lo:	ssh2.xmlh

ping_icmp.lo:	ping_icmp.xmlh

ping_icmp.@MODULEEXT@:	ping_icmp.lo
	@$(MODULELD) $(LDFLAGS) -o $@ $<
	@echo "- linking $@"

external.lo:	external.xmlh

external.@MODULEEXT@:	external.lo external_proc.lo
	@$(MODULELD) $(LDFLAGS) -o $@ external.lo external_proc.lo
	@echo "- linking $@"

.lo.@MODULEEXT@:
	@$(MODULELD) $(LDFLAGS) -o $@ $<
	@echo "- linking $@"

snmp.lo:	snmp.xmlh snmptrap.xmlh

.c.lo:
	@$(CC) $(CPPFLAGS) $(SHCFLAGS) -c $< -o $@
	@echo "- compiling $<"

alldocs:
	for c in *.xml ; do \
		$(XSLTPROC) module.xsl $$c | $(XMLLINT) --format - > $(top_srcdir)/docs/config/modules/$$c ; \
	done

install:	all
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(MODULES_DIR)
	for mod in $(MODULES); do \
		$(INSTALL) -m 0755 $$mod $(DESTDIR)$(MODULES_DIR)/$$mod ; \
	done

clean:
	rm -f *.lo *.@MODULEEXT@ *.xmlh
