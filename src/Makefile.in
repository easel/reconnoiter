.SUFFIXES: .re .c

CC=@CC@
CPPFLAGS=@CPPFLAGS@
CFLAGS=@CFLAGS@
PGCFLAGS=@PGCFLAGS@
LDFLAGS=@LDFLAGS@
AR=@AR@
RANLIB=@RANLIB@
LIBS=@LIBS@
PGLIBS=@PGLIBS@
INSTALL=@INSTALL@
XML2H=@top_srcdir@/buildtools/xml2h

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
libdir=@libdir@
includedir=${prefix}/include
libexecdir=@libexecdir@
datarootdir = @datarootdir@
mandir=@mandir@
mansubdir=@mansubdir@
docdir=${prefix}/@docdir@
sysconfdir=@sysconfdir@
srcdir=@srcdir@
top_srcdir=@top_srcdir@
MODULES_DIR=@MODULES_DIR@

WHOLE_ARCHIVE=@WHOLE_ARCHIVE@
NOWHOLE_ARCHIVE=@NOWHOLE_ARCHIVE@

SUBS=lua utils eventer udns noitedit man stomp
MODDIR=modules

NOIT_OBJS=noitd.o noit_listener.o \
	noit_console.o noit_console_state.o noit_console_telnet.o \
	noit_console_complete.o \
	noit_check.o noit_check_log.o noit_check_tools.o \
	noit_module.o noit_conf.o noit_conf_checks.o noit_tokenizer.o \
	noit_capabilities_listener.o noit_xml.o \
	noit_jlog_listener.o noit_livestream_listener.o noit_filters.o \
        noit_http.o noit_rest.o noit_check_rest.o noit_filters_rest.o

STRATCON_OBJS=stratcond.o noit_listener.o \
	noit_console.o noit_console_state.o noit_console_telnet.o \
	noit_console_complete.o noit_xml.o \
	noit_conf.o noit_http.o noit_rest.o noit_tokenizer.o \
	noit_capabilities_listener.o \
	stratcon_realtime_http.o \
	stratcon_jlog_streamer.o stratcon_datastore.o \
	stratcon_iep.o

all:	noitd stratcond noit.conf test-noit.conf stratcon.conf test-stratcon.conf

make-subdirs:	jlog/libjlog.a
	@for dir in $(SUBS) ; do \
		echo "- building $$dir bits" ; \
		(cd $$dir && make -s) ; \
	done

make-modules:
	@for dir in $(MODDIR) ; do \
		echo "- building $$dir bits" ; \
		(cd $$dir && make -s) ; \
	done

java-bits:
	@echo "- building java bits"
	@test -n "@JAVAPARTS@" && (cd java && make -s)

jlog/libjlog.a:
	@(cd jlog && make libjlog.a)

noitd:	make-subdirs make-modules $(NOIT_OBJS)
	@$(CC) -o $@ $(NOIT_OBJS) \
		udns/libudns.o \
		$(LDFLAGS) \
		$(WHOLE_ARCHIVE) \
		-Leventer -leventer \
		-Lutils -lnoit_utils \
		-Ljlog -ljlog \
		-Lnoitedit -lnoitedit \
		$(NOWHOLE_ARCHIVE) \
		$(LIBS)
	@echo "- linking $@"

stratcond:	make-subdirs $(STRATCON_OBJS) java-bits
	@$(CC) -o $@ $(STRATCON_OBJS) \
		udns/libudns.o \
		$(LDFLAGS) \
		$(WHOLE_ARCHIVE) \
		-Leventer -leventer \
		-Lutils -lnoit_utils \
		-Ljlog -ljlog \
		-Lnoitedit -lnoitedit \
		-Lstomp -lstomp \
		$(NOWHOLE_ARCHIVE) \
		$(LIBS) $(PGLIBS) @APRLIBS@
	@echo "- linking $@"

stratcon_datastore.o:	stratcon_datastore.c
	@$(CC) $(CPPFLAGS) $(PGCFLAGS) -c $<
	@echo "- compiling $<"

stratcon_iep.o:	stratcon_iep.c
	@$(CC) $(CPPFLAGS) $(CFLAGS) @APRCFLAGS@ -c $<
	@echo "- compiling $<"

.c.o:
	@$(CC) $(CPPFLAGS) $(CFLAGS) -c $<
	@echo "- compiling $<"

noit_module.o:	module-online.h

module-online.h:	modules/module-online.xsl
	@echo "- making module-online.h (StyleSheet include)"
	@$(XML2H) helpStyleXML < modules/module-online.xsl > $@

noit_tokenizer.c:	noit_tokenizer.re
	@re2c -o $@ noit_tokenizer.re
	@echo "- re2c noit_tokenizer.re"

test-noit.conf:	noit.conf.in Makefile
	sed -e "s^%sysconfdir%^`pwd`^g;" \
		-e "s^%modulesdir%^`pwd`/modules^g;" \
		-e "s^%modulesluadir%^`pwd`/modules-lua^g;" \
		-e "s^%PKIPREFIX%^../test/test-^g;" < \
		noit.conf.in > \
		test-noit.conf

noit.conf:	noit.conf.in Makefile
	sed -e "s^%sysconfdir%^$(sysconfdir)^g;" \
		-e "s^%modulesdir%^$(MODULES_DIR)^g;" \
		-e "s^%modulesluadir%^$(MODULES_DIR)^g;" \
		-e "s^%PKIPREFIX%^$${PKIPREFIX}^g;" < \
		noit.conf.in > \
		noit.conf

test-stratcon.conf:	stratcon.conf.in Makefile
	sed -e "s^%sysconfdir%^`pwd`^g;" \
		-e "s^%modulesdir%^`pwd`/modules^g;" \
		-e "s^%modulesluadir%^`pwd`/modules-lua^g;" \
		-e "s^%iepbindir%^`pwd`/java^g;" \
		-e "s^%iepdbdir%^`pwd`/java^g;" \
		-e "s^%PKIPREFIX%^../test/test-^g;" < \
		stratcon.conf.in > \
		test-stratcon.conf

stratcon.conf:	stratcon.conf.in Makefile
	sed -e "s^%sysconfdir%^$(sysconfdir)^g;" \
		-e "s^%modulesdir%^$(MODULES_DIR)^g;" \
		-e "s^%modulesluadir%^$(MODULES_DIR)^g;" \
		-e "s^%iepbindir%^$(bindir)^g;" \
		-e "s^%iepdbdir%^$(prefix)/var/db^g;" \
		-e "s^%PKIPREFIX%^$${PKIPREFIX}^g;" < \
		stratcon.conf.in > \
		stratcon.conf

install-dirs:
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(bindir)
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(sbindir)
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(sysconfdir)

install-noitd:	noitd noit.conf
	$(INSTALL) -m 0755 scripts/noittrap $(DESTDIR)$(bindir)/noittrap
	$(INSTALL) -m 0755 noitd $(DESTDIR)$(sbindir)/noitd
	$(INSTALL) -m 0644 noit.conf $(DESTDIR)$(sysconfdir)/noit.conf.sample
	$(INSTALL) -m 0644 default-ca-chain.crt $(DESTDIR)$(sysconfdir)/default-ca-chain.crt
	(cd modules && make install DESTDIR=$(DESTDIR))
	(cd modules-lua && make install DESTDIR=$(DESTDIR))

install-stratcond:	install-dirs stratcond stratcon.conf java-bits
	$(INSTALL) -m 0755 stratcond $(DESTDIR)$(sbindir)/stratcond
	$(INSTALL) -m 0644 stratcon.conf $(DESTDIR)$(sysconfdir)/stratcon.conf.sample
	test -n "@JAVAPARTS@" && (cd @JAVAPARTS@ && make install DESTDIR=$(DESTDIR))

install-docs:
	(cd man && make install DESTDIR=$(DESTDIR))

install:	install-dirs install-docs install-noitd install-stratcond

clean-subdirs:
	for dir in $(SUBS) ; do \
		(cd $$dir && make clean) ; \
	done
	(cd java && make clean)

clean:	clean-subdirs
	rm -f *.o noitd
	rm jlog/libjlog.a
	(cd jlog && make clean)

